name: Weekly Update Worker

# Runs every Tuesday at 4 AM UTC (Sunday night / Monday morning in US)
# Also can be triggered manually for a specific league

on:
  schedule:
    # 4 AM UTC on Tuesdays = 11 PM EST Monday / 8 PM PST Monday
    # This is after Monday Night Football finishes
    - cron: '0 4 * * 2'

  workflow_dispatch:
    inputs:
      database_name:
        description: 'MotherDuck database name (leave empty for all leagues)'
        required: false
        type: string
      week:
        description: 'Force specific week (leave empty for auto-detect)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (show what would happen without doing it)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  # First, discover all leagues and detect current NFL week (ONE API call for all)
  discover-leagues:
    runs-on: ubuntu-latest
    outputs:
      leagues: ${{ steps.list.outputs.leagues }}
      league_count: ${{ steps.list.outputs.count }}
      current_week: ${{ steps.week.outputs.current_week }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python for discovery
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install duckdb yahoo_oauth requests

      - name: List registered leagues
        id: list
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
          TARGET_DB: ${{ github.event.inputs.database_name || '' }}
        run: |
          # If specific database requested, just use that
          if [ -n "$TARGET_DB" ]; then
            echo "leagues=[\"${TARGET_DB}\"]" >> $GITHUB_OUTPUT
            echo "count=1" >> $GITHUB_OUTPUT
            echo "Targeting specific database: ${TARGET_DB}"
            exit 0
          fi

          # Query MotherDuck to discover all fantasy football databases
          python - <<'PYEOF'
          import duckdb
          import os
          import json

          token = os.environ.get('MOTHERDUCK_TOKEN', '')
          if not token:
              print("No MOTHERDUCK_TOKEN found")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('leagues=[]\n')
                  f.write('count=0\n')
              exit(0)

          try:
              conn = duckdb.connect(f"md:?motherduck_token={token}")

              # Get all databases
              dbs = conn.execute("SELECT database_name FROM information_schema.schemata WHERE schema_name = 'public'").fetchall()
              all_dbs = [row[0] for row in dbs]

              # Filter to fantasy football databases (have matchup table)
              fantasy_dbs = []
              for db in all_dbs:
                  if db in ('information_schema', 'my_db', 'sample_data'):
                      continue
                  try:
                      # Check if this database has a matchup table (indicates fantasy football)
                      conn.execute(f"SELECT 1 FROM {db}.public.matchup LIMIT 1")
                      fantasy_dbs.append(db)
                      print(f"  ‚úì {db} - fantasy football database")
                  except:
                      print(f"  ‚úó {db} - skipping (no matchup table)")

              conn.close()

              print(f"\nFound {len(fantasy_dbs)} fantasy football databases")

              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f'leagues={json.dumps(fantasy_dbs)}\n')
                  f.write(f'count={len(fantasy_dbs)}\n')

          except Exception as e:
              print(f"Error discovering databases: {e}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('leagues=[]\n')
                  f.write('count=0\n')
          PYEOF

      - name: Detect current NFL week (once for all leagues)
        id: week
        env:
          YAHOO_CLIENT_ID: ${{ secrets.YAHOO_CLIENT_ID }}
          YAHOO_CLIENT_SECRET: ${{ secrets.YAHOO_CLIENT_SECRET }}
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
          CREDENTIAL_ENCRYPTION_KEY: ${{ secrets.CREDENTIAL_ENCRYPTION_KEY }}
          MANUAL_WEEK: ${{ github.event.inputs.week || '' }}
        run: |
          # If week manually specified, use that
          if [ -n "$MANUAL_WEEK" ]; then
            echo "current_week=${MANUAL_WEEK}" >> $GITHUB_OUTPUT
            echo "Using manually specified week: ${MANUAL_WEEK}"
            exit 0
          fi

          python - <<'PYEOF'
          import os
          import sys
          import json
          import time
          from datetime import date, timedelta
          from pathlib import Path

          def date_based_week_estimate():
              """Fallback: estimate NFL week from date (Week 1 ~= Thursday after Labor Day)"""
              today = date.today()
              year = today.year

              # Find Labor Day (first Monday of September)
              sept1 = date(year, 9, 1)
              days_to_monday = (7 - sept1.weekday()) % 7
              if sept1.weekday() == 0:
                  labor_day = sept1
              else:
                  labor_day = sept1 + timedelta(days=days_to_monday)

              # Week 1 starts Thursday after Labor Day
              week1_start = labor_day + timedelta(days=3)

              if today < week1_start:
                  return 1  # Preseason

              days_since_week1 = (today - week1_start).days
              current_week = (days_since_week1 // 7) + 1
              return min(max(current_week, 1), 18)  # Clamp to 1-18

          def get_week_from_yahoo():
              """Get current week from Yahoo API using stored credentials"""
              try:
                  # Try to get credentials from any league
                  sys.path.insert(0, 'fantasy_football_data_scripts')
                  from multi_league.utils.credential_store import retrieve_league_credentials
                  import duckdb

                  token = os.environ.get('MOTHERDUCK_TOKEN', '')
                  if not token:
                      return None

                  # Find first league with credentials
                  conn = duckdb.connect(f"md:?motherduck_token={token}")
                  dbs = conn.execute("SELECT database_name FROM information_schema.schemata WHERE schema_name = 'public'").fetchall()
                  conn.close()

                  refresh_token = None
                  league_key = None

                  for (db_name,) in dbs:
                      if db_name in ('information_schema', 'my_db', 'sample_data'):
                          continue
                      try:
                          creds = retrieve_league_credentials(db_name)
                          if creds and creds.get('refresh_token'):
                              refresh_token = creds['refresh_token']
                              # Try to get league_key from league_settings
                              conn = duckdb.connect(f"md:{db_name}?motherduck_token={token}")
                              try:
                                  result = conn.execute("SELECT league_key FROM league_settings ORDER BY year DESC LIMIT 1").fetchone()
                                  if result:
                                      league_key = result[0]
                              except:
                                  pass
                              conn.close()
                              if league_key:
                                  print(f"Using credentials from {db_name}, league_key: {league_key}")
                                  break
                      except:
                          continue

                  if not refresh_token:
                      print("No stored credentials found")
                      return None

                  # Create OAuth file and get current week
                  consumer_key = os.environ.get('YAHOO_CLIENT_ID')
                  consumer_secret = os.environ.get('YAHOO_CLIENT_SECRET')

                  if not consumer_key or not consumer_secret:
                      print("Missing Yahoo credentials")
                      return None

                  # Create temp OAuth file
                  oauth_data = {
                      'consumer_key': consumer_key,
                      'consumer_secret': consumer_secret,
                      'refresh_token': refresh_token,
                      'token_time': time.time() - 7200,
                  }

                  Path("oauth").mkdir(exist_ok=True)
                  with open("oauth/Oauth.json", 'w') as f:
                      json.dump(oauth_data, f)

                  # Query Yahoo for current week
                  from yahoo_oauth import OAuth2
                  oauth = OAuth2(None, None, from_file="oauth/Oauth.json")

                  if not oauth.token_is_valid():
                      oauth.refresh_access_token()

                  # Get current NFL game info
                  year = date.today().year
                  url = f"https://fantasysports.yahooapis.com/fantasy/v2/game/nfl"
                  resp = oauth.session.get(url)

                  if resp.status_code == 200:
                      import re
                      # Parse current_week from XML response
                      match = re.search(r'<current_week>(\d+)</current_week>', resp.text)
                      if match:
                          week = int(match.group(1))
                          print(f"Yahoo API returned current_week: {week}")
                          return week

                  print(f"Yahoo API call failed: {resp.status_code}")
                  return None

              except Exception as e:
                  print(f"Error getting week from Yahoo: {e}")
                  return None

          # Try Yahoo first, fall back to date-based estimate
          current_week = get_week_from_yahoo()

          if current_week is None:
              current_week = date_based_week_estimate()
              print(f"Using date-based estimate: week {current_week}")

          # Determine target week based on day of week
          # On Tuesday-Saturday: the current_week just finished (MNF is Monday night)
          # On Sunday-Monday: games still in progress, so previous week is complete
          from datetime import date
          today = date.today()
          weekday = today.weekday()  # 0=Monday, 1=Tuesday, ..., 6=Sunday

          if weekday >= 1 and weekday <= 5:  # Tuesday-Saturday
              # Week's games are complete (MNF ended Monday night)
              target_week = current_week
          else:  # Sunday or Monday
              # Games still in progress
              target_week = max(1, current_week - 1)

          print(f"Current NFL week: {current_week}, today is weekday {weekday}, targeting completed week: {target_week}")

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'current_week={target_week}\n')
          PYEOF

  # Update each league
  update-league:
    needs: discover-leagues
    if: needs.discover-leagues.outputs.league_count != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false  # Continue updating other leagues even if one fails
      matrix:
        database: ${{ fromJson(needs.discover-leagues.outputs.leagues) }}

    env:
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download existing data from MotherDuck
        id: download
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
          DATABASE_NAME: ${{ matrix.database }}
        run: |
          echo "========================================"
          echo "Downloading existing data for: ${DATABASE_NAME}"
          echo "========================================"

          mkdir -p fantasy_football_data

          python - <<'PYEOF'
          import duckdb
          import os
          from pathlib import Path

          db_name = os.environ['DATABASE_NAME']
          token = os.environ['MOTHERDUCK_TOKEN']
          output_dir = Path("fantasy_football_data")

          print(f"Connecting to MotherDuck database: {db_name}")

          try:
              conn = duckdb.connect(f"md:{db_name}?motherduck_token={token}")

              # Get list of tables
              tables = conn.execute("SHOW TABLES").fetchall()
              print(f"Found {len(tables)} tables")

              for (table_name,) in tables:
                  print(f"  Downloading {table_name}...")
                  output_file = output_dir / f"{table_name}.parquet"
                  conn.execute(f"COPY (SELECT * FROM {table_name}) TO '{output_file}' (FORMAT PARQUET)")
                  print(f"    -> {output_file}")

              conn.close()
              print("‚úÖ Download complete")

          except Exception as e:
              print(f"‚ùå Error downloading data: {e}")
              # Continue anyway - may be a new database
              exit(0)
          PYEOF

      - name: Reconstruct league context
        id: context
        env:
          DATABASE_NAME: ${{ matrix.database }}
          YAHOO_CLIENT_ID: ${{ secrets.YAHOO_CLIENT_ID }}
          YAHOO_CLIENT_SECRET: ${{ secrets.YAHOO_CLIENT_SECRET }}
        run: |
          python - <<'PYEOF'
          import json
          import os
          from pathlib import Path
          import pandas as pd

          db_name = os.environ['DATABASE_NAME']
          data_dir = Path("fantasy_football_data")

          # Format league name for display (strip l_ prefix if present for digit-starting names)
          display_name = db_name
          if db_name.startswith('l_') and len(db_name) > 2 and db_name[2].isdigit():
              display_name = db_name[2:]  # Strip the l_ prefix
          league_name = display_name.replace('_', ' ').title()

          # Try to read league info from league_settings.parquet
          settings_file = data_dir / "league_settings.parquet"

          if settings_file.exists():
              df = pd.read_parquet(settings_file)
              if not df.empty:
                  # Get most recent year's settings
                  latest = df.sort_values('year', ascending=False).iloc[0]

                  context = {
                      "league_id": latest.get('league_key', db_name),
                      "league_name": league_name,
                      "oauth_file_path": str(Path("oauth/Oauth.json").resolve()),
                      "game_code": "nfl",
                      "start_year": int(df['year'].min()),
                      "end_year": int(df['year'].max()),
                      "num_teams": int(latest.get('num_teams', 10)),
                      "playoff_teams": int(latest.get('num_playoff_teams', 6)),
                      "data_directory": str(data_dir.resolve()),
                      "max_workers": 5,
                      "enable_caching": True,
                      "rate_limit_per_sec": 4.0,
                  }

                  # Try to load league_ids mapping from settings_json
                  try:
                      settings_json = json.loads(latest.get('settings_json', '{}'))
                      if 'league_ids' in settings_json:
                          context['league_ids'] = settings_json['league_ids']
                  except:
                      pass

                  with open("league_context.json", 'w') as f:
                      json.dump(context, f, indent=2)

                  print(f"‚úÖ Reconstructed context for {db_name}")
                  print(json.dumps(context, indent=2))
                  exit(0)

          # Fallback: create minimal context
          print(f"‚ö†Ô∏è Could not find league_settings.parquet, creating minimal context")
          context = {
              "league_id": db_name,
              "league_name": league_name,  # Uses the display name computed above
              "oauth_file_path": str(Path("oauth/Oauth.json").resolve()),
              "game_code": "nfl",
              "start_year": 2020,
              "end_year": 2024,
              "data_directory": str(data_dir.resolve()),
          }

          with open("league_context.json", 'w') as f:
              json.dump(context, f, indent=2)

          print(json.dumps(context, indent=2))
          PYEOF

      - name: Retrieve stored credentials
        id: creds
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
          CREDENTIAL_ENCRYPTION_KEY: ${{ secrets.CREDENTIAL_ENCRYPTION_KEY }}
          YAHOO_CLIENT_ID: ${{ secrets.YAHOO_CLIENT_ID }}
          YAHOO_CLIENT_SECRET: ${{ secrets.YAHOO_CLIENT_SECRET }}
          YAHOO_MASTER_REFRESH_TOKEN: ${{ secrets.YAHOO_MASTER_REFRESH_TOKEN }}
          DATABASE_NAME: ${{ matrix.database }}
        run: |
          mkdir -p oauth

          echo "========================================"
          echo "Retrieving stored credentials for: ${DATABASE_NAME}"
          echo "========================================"

          python - <<'PYEOF'
          import json
          import os
          import sys
          import time

          sys.path.insert(0, 'fantasy_football_data_scripts')

          database_name = os.environ['DATABASE_NAME']
          consumer_key = os.environ.get('YAHOO_CLIENT_ID')
          consumer_secret = os.environ.get('YAHOO_CLIENT_SECRET')
          encryption_key = os.environ.get('CREDENTIAL_ENCRYPTION_KEY')
          master_refresh_token = os.environ.get('YAHOO_MASTER_REFRESH_TOKEN')

          refresh_token = None
          token_source = None

          # Try to retrieve stored credentials from MotherDuck
          if encryption_key:
              try:
                  from multi_league.utils.credential_store import retrieve_league_credentials
                  creds = retrieve_league_credentials(database_name)
                  if creds:
                      refresh_token = creds.get('refresh_token')
                      token_source = "per-league"
                      print(f"‚úÖ Retrieved stored credentials for {creds.get('league_name')}")
              except Exception as e:
                  print(f"‚ö†Ô∏è Could not retrieve stored credentials: {e}")
          else:
              print("‚ö†Ô∏è CREDENTIAL_ENCRYPTION_KEY not set - cannot decrypt stored credentials")

          # Validate per-league token if we have one
          token_valid = False
          if refresh_token and consumer_key and consumer_secret:
              print("üîç Validating per-league token...")
              try:
                  import tempfile
                  # Create temp OAuth file to test
                  test_oauth = {
                      'consumer_key': consumer_key,
                      'consumer_secret': consumer_secret,
                      'refresh_token': refresh_token,
                      'token_time': time.time() - 7200,
                  }
                  with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:
                      json.dump(test_oauth, f)
                      test_file = f.name

                  # Try to refresh the token
                  from yahoo_oauth import OAuth2
                  oauth = OAuth2(None, None, from_file=test_file)
                  if oauth.token_is_valid():
                      token_valid = True
                      print("‚úÖ Per-league token is valid")
                  else:
                      # Try to refresh
                      oauth.refresh_access_token()
                      token_valid = True
                      print("‚úÖ Per-league token refreshed successfully")

                      # Save the new refresh token back to MotherDuck (keeps it alive)
                      new_refresh = getattr(oauth, 'refresh_token', None)
                      if new_refresh and new_refresh != refresh_token:
                          print("üîÑ Saving refreshed token back to storage...")
                          try:
                              from multi_league.utils.credential_store import store_league_credentials
                              store_league_credentials(
                                  database_name=database_name,
                                  refresh_token=new_refresh,
                                  league_id=creds.get('league_id', database_name),
                                  league_name=creds.get('league_name', database_name)
                              )
                              refresh_token = new_refresh  # Use the new one
                              print("‚úÖ Token persisted - will stay valid for future runs")
                          except Exception as store_err:
                              print(f"‚ö†Ô∏è Could not persist token: {store_err}")

                  os.unlink(test_file)
              except Exception as e:
                  print(f"‚ö†Ô∏è Per-league token validation failed: {e}")
                  token_valid = False

          # Fallback to master token if per-league not available or invalid
          if (not refresh_token or not token_valid) and master_refresh_token:
              refresh_token = master_refresh_token
              token_source = "master"
              print("üìå Using master refresh token as fallback")

          if not refresh_token:
              print("‚ö†Ô∏è No refresh token available - data fetching may fail")
              print("   This league may need to be re-imported to store credentials")
              print("   Or add YAHOO_MASTER_REFRESH_TOKEN as a GitHub secret for fallback")

          # Create OAuth file
          oauth_data = {
              'consumer_key': consumer_key,
              'consumer_secret': consumer_secret,
              'refresh_token': refresh_token,
              'token_time': time.time() - 7200,  # Force refresh
          }

          with open("oauth/Oauth.json", 'w') as f:
              json.dump(oauth_data, f, indent=2)

          # Set output for later steps
          has_token = "true" if refresh_token else "false"
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"has_refresh_token={has_token}\n")
              f.write(f"token_source={token_source or 'none'}\n")

          if refresh_token:
              print(f"‚úÖ OAuth credentials configured (source: {token_source})")
          else:
              print("‚ö†Ô∏è OAuth file created but may not work without refresh token")
          PYEOF

      - name: Run weekly update
        id: update
        env:
          DATABASE_NAME: ${{ matrix.database }}
          DETECTED_WEEK: ${{ needs.discover-leagues.outputs.current_week }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        working-directory: fantasy_football_data_scripts
        run: |
          echo "========================================"
          echo "Running weekly update for: ${DATABASE_NAME}"
          echo "Using pre-detected week: ${DETECTED_WEEK}"
          echo "========================================"

          ARGS="--context ../league_context.json"

          # Use the week detected once in discover-leagues (no per-league API call)
          if [ -n "$DETECTED_WEEK" ]; then
            ARGS="$ARGS --week $DETECTED_WEEK"
          fi

          if [ "$DRY_RUN" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          echo "Command: python weekly_update_v2.py $ARGS"

          python weekly_update_v2.py $ARGS 2>&1 | tee ../weekly_update.log

          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Weekly update completed successfully"
          else
            echo "‚ùå Weekly update failed with exit code ${EXIT_CODE}"
            tail -100 ../weekly_update.log
          fi

      - name: Upload updated data to MotherDuck
        if: steps.update.outputs.exit_code == '0' && github.event.inputs.dry_run != 'true'
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
          DATABASE_NAME: ${{ matrix.database }}
        run: |
          echo "========================================"
          echo "Uploading updated data to MotherDuck"
          echo "========================================"

          cd fantasy_football_data
          python motherduck_upload.py "${DATABASE_NAME}" . 2>&1 | tee ../motherduck_upload.log

          if [ $? -eq 0 ]; then
            echo "‚úÖ Upload complete!"
          else
            echo "‚ùå Upload failed"
            tail -50 ../motherduck_upload.log
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-update-${{ matrix.database }}
          path: |
            weekly_update.log
            motherduck_upload.log
            league_context.json
          retention-days: 7

      - name: Update workflow summary
        if: always()
        run: |
          echo "# Weekly Update: ${{ matrix.database }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.update.outputs.exit_code }}" == "0" ]; then
            echo "## ‚úÖ Update Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Update Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Database**: \`${{ matrix.database }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Week**: ${{ needs.discover-leagues.outputs.current_week }}" >> $GITHUB_STEP_SUMMARY

  # Summary job
  summary:
    needs: [discover-leagues, update-league]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Create summary
        run: |
          echo "# Weekly Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -Iseconds)" >> $GITHUB_STEP_SUMMARY
          echo "- **NFL Week**: ${{ needs.discover-leagues.outputs.current_week }} (detected once for all leagues)" >> $GITHUB_STEP_SUMMARY
          echo "- **Leagues Processed**: ${{ needs.discover-leagues.outputs.league_count }}" >> $GITHUB_STEP_SUMMARY
