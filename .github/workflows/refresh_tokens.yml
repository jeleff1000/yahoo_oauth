name: Refresh OAuth Tokens

# Manual workflow to refresh/update OAuth tokens for leagues
# Use this when tokens expire or after changing Yahoo app credentials

on:
  workflow_dispatch:
    inputs:
      refresh_token:
        description: 'Refresh token from local Streamlit auth (paste from oauth/Oauth.json)'
        required: true
        type: string
      target_database:
        description: 'Target database (leave empty for ALL leagues)'
        required: false
        type: string
      update_master_secret:
        description: 'Also show instructions to update YAHOO_MASTER_REFRESH_TOKEN'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  refresh-tokens:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install duckdb requests cryptography yahoo_oauth

      - name: Validate and refresh token
        id: validate
        env:
          YAHOO_CLIENT_ID: ${{ secrets.YAHOO_CLIENT_ID }}
          YAHOO_CLIENT_SECRET: ${{ secrets.YAHOO_CLIENT_SECRET }}
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
          CREDENTIAL_ENCRYPTION_KEY: ${{ secrets.CREDENTIAL_ENCRYPTION_KEY }}
          INPUT_REFRESH_TOKEN: ${{ github.event.inputs.refresh_token }}
          TARGET_DB: ${{ github.event.inputs.target_database }}
        run: |
          python - <<'PYEOF'
          import os
          import sys
          import json
          import time
          import tempfile
          import duckdb

          # Get inputs
          refresh_token = os.environ.get('INPUT_REFRESH_TOKEN', '').strip()
          consumer_key = os.environ.get('YAHOO_CLIENT_ID')
          consumer_secret = os.environ.get('YAHOO_CLIENT_SECRET')
          md_token = os.environ.get('MOTHERDUCK_TOKEN')
          encryption_key = os.environ.get('CREDENTIAL_ENCRYPTION_KEY')
          target_db = os.environ.get('TARGET_DB', '').strip()

          if not refresh_token:
              print("âŒ No refresh token provided")
              sys.exit(1)

          if not consumer_key or not consumer_secret:
              print("âŒ YAHOO_CLIENT_ID or YAHOO_CLIENT_SECRET not set in secrets")
              sys.exit(1)

          print("=" * 60)
          print("STEP 1: Validating refresh token with Yahoo")
          print("=" * 60)

          # Create temp OAuth file and test the token
          oauth_data = {
              'consumer_key': consumer_key,
              'consumer_secret': consumer_secret,
              'access_token': 'expired_placeholder',
              'refresh_token': refresh_token,
              'token_time': 0,  # Force refresh
          }

          with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:
              json.dump(oauth_data, f)
              test_file = f.name

          try:
              from yahoo_oauth import OAuth2
              oauth = OAuth2(None, None, from_file=test_file)

              if not oauth.token_is_valid():
                  oauth.refresh_access_token()

              # Get the refreshed tokens
              new_access_token = getattr(oauth, 'access_token', None)
              new_refresh_token = getattr(oauth, 'refresh_token', refresh_token)

              if not new_access_token:
                  print("âŒ Token refresh failed - no access_token returned")
                  print("   Make sure the refresh_token matches your YAHOO_CLIENT_ID/SECRET")
                  sys.exit(1)

              print(f"âœ… Token validated successfully!")
              print(f"   Access token: {new_access_token[:30]}...")
              print(f"   Refresh token: {new_refresh_token[:30]}...")

              # Test an API call
              print("\n   Testing Yahoo API call...")
              url = "https://fantasysports.yahooapis.com/fantasy/v2/users;use_login=1/games?format=json"
              resp = oauth.session.get(url)
              if resp.status_code == 200:
                  print("   âœ… API call successful - token is fully working!")
              else:
                  print(f"   âš ï¸ API call returned {resp.status_code} - token may have limited access")

          except Exception as e:
              print(f"âŒ Token validation failed: {e}")
              print("\nCommon causes:")
              print("  1. Refresh token was created with different Yahoo app credentials")
              print("  2. Refresh token has expired (they last ~30 days if unused)")
              print("  3. Yahoo app was deleted or modified")
              print("\nSolution: Re-authenticate in Streamlit to get a fresh token")
              sys.exit(1)
          finally:
              os.unlink(test_file)

          print("\n" + "=" * 60)
          print("STEP 2: Discovering league databases")
          print("=" * 60)

          if not md_token:
              print("âš ï¸ MOTHERDUCK_TOKEN not set - cannot update stored credentials")
              print("   Token is valid but won't be stored in MotherDuck")
              sys.exit(0)

          # Find all league databases
          conn = duckdb.connect(f"md:?motherduck_token={md_token}")

          dbs = conn.execute("""
              SELECT DISTINCT catalog_name
              FROM information_schema.schemata
              WHERE schema_name = 'public'
          """).fetchall()

          # Filter to fantasy football databases
          league_dbs = []
          for (db_name,) in dbs:
              if db_name in ('information_schema', 'my_db', 'sample_data', 'system', 'temp', 'memory'):
                  continue
              try:
                  conn.execute(f"SELECT 1 FROM {db_name}.public.matchup LIMIT 1")
                  league_dbs.append(db_name)
              except:
                  pass

          conn.close()

          print(f"Found {len(league_dbs)} league databases: {league_dbs}")

          # Filter to target if specified
          if target_db:
              if target_db in league_dbs:
                  league_dbs = [target_db]
                  print(f"Targeting specific database: {target_db}")
              else:
                  print(f"âš ï¸ Target database '{target_db}' not found in league list")
                  print(f"   Available: {league_dbs}")
                  sys.exit(1)

          print("\n" + "=" * 60)
          print("STEP 3: Updating credentials in MotherDuck")
          print("=" * 60)

          if not encryption_key:
              print("âš ï¸ CREDENTIAL_ENCRYPTION_KEY not set - cannot encrypt tokens")
              print("   Token is valid but won't be stored securely")
              sys.exit(0)

          # Import credential store
          sys.path.insert(0, 'fantasy_football_data_scripts')
          from multi_league.utils.credential_store import store_league_credentials

          success_count = 0
          for db_name in league_dbs:
              try:
                  # Get league info from the database
                  conn = duckdb.connect(f"md:{db_name}?motherduck_token={md_token}")

                  # Try to get league_id from various sources
                  league_id = db_name
                  league_name = db_name.replace('_', ' ').title()

                  try:
                      result = conn.execute("SELECT league_key FROM league_settings ORDER BY year DESC LIMIT 1").fetchone()
                      if result:
                          league_id = result[0]
                  except:
                      pass

                  try:
                      result = conn.execute("SELECT league_id, league_name FROM league_context LIMIT 1").fetchone()
                      if result:
                          league_id = result[0] or league_id
                          league_name = result[1] or league_name
                  except:
                      pass

                  conn.close()

                  # Store the credentials
                  success = store_league_credentials(
                      database_name=db_name,
                      refresh_token=new_refresh_token,
                      league_id=league_id,
                      league_name=league_name
                  )

                  if success:
                      print(f"âœ… {db_name}: Credentials updated")
                      success_count += 1
                  else:
                      print(f"âŒ {db_name}: Failed to store credentials")

              except Exception as e:
                  print(f"âŒ {db_name}: Error - {e}")

          print("\n" + "=" * 60)
          print("SUMMARY")
          print("=" * 60)
          print(f"âœ… Updated {success_count}/{len(league_dbs)} league databases")

          # Save new refresh token for output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"new_refresh_token={new_refresh_token}\n")
              f.write(f"leagues_updated={success_count}\n")

          PYEOF

      - name: Create summary
        if: always()
        env:
          UPDATE_MASTER: ${{ github.event.inputs.update_master_secret }}
          NEW_TOKEN: ${{ steps.validate.outputs.new_refresh_token }}
        run: |
          echo "# OAuth Token Refresh Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            echo "## âœ… Token Refresh Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Leagues Updated**: ${{ steps.validate.outputs.leagues_updated }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Token Source**: Manual input" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$UPDATE_MASTER" == "true" ]; then
              echo "## ðŸ“ Update YAHOO_MASTER_REFRESH_TOKEN" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "To update your master fallback token:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "1. Go to **Settings â†’ Secrets and variables â†’ Actions**" >> $GITHUB_STEP_SUMMARY
              echo "2. Edit \`YAHOO_MASTER_REFRESH_TOKEN\`" >> $GITHUB_STEP_SUMMARY
              echo "3. Paste your refresh token (same one you used here)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> This ensures weekly updates have a fallback if per-league tokens fail" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your weekly updates should now work! The tokens will auto-refresh each week." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Token Refresh Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Common Solutions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Get a fresh token**: Run Streamlit locally, authenticate with Yahoo" >> $GITHUB_STEP_SUMMARY
            echo "2. **Check Yahoo app**: Make sure YAHOO_CLIENT_ID and YAHOO_CLIENT_SECRET match your app" >> $GITHUB_STEP_SUMMARY
            echo "3. **Re-import leagues**: If tokens are completely dead, re-import via Streamlit" >> $GITHUB_STEP_SUMMARY
          fi
